<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LUMIX Admin">
    <meta name="theme-color" content="#1e293b">
    <link rel="manifest" href="data:application/manifest+json;base64,ew0KICAgICJuYW1lIjogIkxVTUlYIEFkbWluIiwNCiAgICAic2hvcnRfbmFtZSI6ICJBZG1pbiIsDQogICAgInN0YXJ0X3VybCI6ICIuIiwNCiAgICAiZGlzcGxheSI6ICJmdWxsc2NyZWVuIiwNCiAgICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMWUyOTNiIiwNCiAgICAidGhlbWVfY29sb3IiOiAiIzFlMjkzYiIsDQogICAgImRlc2NyaXB0aW9uIjogIlBhaW5lbCBkZSBHZXN0w6NvIGRhIExVTUlYIEZpbmFuw6dhcy4iLA0KICAgICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsDQogICAgImljb25zIjogWw0KICAgICAgICB7DQogICAgICAgICAgICAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzE5MngxOTIvMWUyOTNiL0ZGRkZGRj90ZXh0PUEiLA0KICAgICAgICAgICAgInNpemVzIjogIjE5MngxOTIiLA0KICAgICAgICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIg0KICAgICAgICB9LA0KICAgICAgICB7DQogICAgICAgICAgICAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1MTIvMWUyOTNiL0ZGRkZGRj90ZXh0PUEiLA0KICAgICAgICAgICAgInNpemVzIjogIjUxMng1MTIiLA0KICAgICAgICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIg0KICAgICAgICB9DQogICAgXQ0KfQ0K">
    <title>Painel do Administrador</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <style>
        :root {
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --accent-green: #22c55e;
            --accent-blue: #3b82f6;
            --accent-blue-darker: #2563eb;
            --border-color: #e2e8f0;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }
        body.dark-mode {
            --bg: #020617;
            --surface: #0f172a;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #1e293b;
            --danger-color: #f87171;
            --warning-color: #f59e0b;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.9; }
        }

        @keyframes subtle-glow {
          0%, 100% {
            filter: drop-shadow(0 0 8px rgba(138, 43, 226, 0.7));
          }
          50% {
            filter: drop-shadow(0 0 16px rgba(57, 255, 20, 0.7));
          }
        }

        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg);
            display: flex; justify-content: center; align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease-out;
        }
        #splash-screen img { 
            width: 150px; 
            height: 150px; 
            animation: pulse 2.5s infinite ease-in-out;
        }

        #login-view {
            display: none; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; padding: 20px;
            background-color: var(--bg);
        }
        .login-card {
            background-color: transparent;
            box-shadow: none;
            border: none;
            width: 100%; max-width: 400px; text-align: center;
        }
        
        .login-card .logo {
            display: flex;
            justify-content: center;
        }

        .login-card .logo img { 
            width: 140px; 
            height: 140px; 
            margin-bottom: 30px; 
            animation: subtle-glow 5s ease-in-out infinite;
        }
        .login-card h2 { margin-bottom: 10px; font-size: 1.8em; font-weight: 700; color: var(--text-primary); }
        .login-card p { margin-bottom: 40px; color: var(--text-secondary); }
        .login-card .form-group { text-align: left; margin-bottom: 20px; }
        .login-card .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .login-card .form-group input { 
            width: 100%; 
            padding: 15px; 
            font-size: 1em; 
            border-radius: 8px; 
            border: 1px solid #334155; 
            background-color: #1e293b; 
            color: var(--text-primary); 
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .login-card .form-group input:focus {
            border-color: var(--accent-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .login-card .btn-primary { 
            width: 100%; 
            padding: 15px; 
            font-size: 1.1em;
            font-weight: 600;
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            background-color: var(--accent-blue); 
            color: white; 
            transition: background-color 0.2s;
        }
        .login-card .btn-primary:hover {
            background-color: var(--accent-blue-darker);
        }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; font-size: 1em; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--surface); color: var(--text-primary); }
        .form-group input[readonly] { background-color: var(--bg); opacity: 0.7; cursor: not-allowed; }
        .form-group .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .day-selector { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 20px; }
        .day-selector label { padding: 10px; flex-grow: 1; font-weight: 600; font-size: 0.9em; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; background-color: var(--surface); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; }
        .day-selector input { display: none; }
        .day-selector input:checked + label { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }

        #app-container { 
            display: none; flex-direction: column;
            height: 100%; width: 100%;
        }
        main { flex-grow: 1; overflow-y: auto; }
        .container { padding: 20px; }
        
        .main-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--surface); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; flex-shrink: 0; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo img { height: 40px; width: 40px; object-fit: cover; }
        .logo-text { font-size: 1.2em; font-weight: 700; color: var(--text-primary); }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .header-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 5px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .lang-dropdown { display: none; position: absolute; top: 40px; right: 0; background-color: var(--surface); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid var(--border-color); overflow: hidden; z-index: 110; }
        .lang-dropdown button { display: block; width: 100%; text-align: left; padding: 10px 15px; background: none; border: none; color: var(--text-primary); cursor: pointer; }
        .lang-dropdown button:hover { background-color: var(--bg); }
        .profile img { height: 40px; width: 40px; border-radius: 50%; border: 2px solid var(--accent-blue); object-fit: cover; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .kpi-card { background-color: var(--surface); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); border: 1px solid var(--border-color); }
        body.dark-mode .kpi-card { box-shadow: none; }
        .kpi-title { display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: var(--text-secondary); margin: 0 0 10px; }
        .kpi-value { font-size: 1.8em; font-weight: 700; margin: 0; }
        
        .section-title { font-size: 1.3em; font-weight: 600; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .item-list { display: flex; flex-direction: column; gap: 15px; }
        
        .client-card, .report-item-card { background-color: var(--surface); border-radius: 12px; padding: 15px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--border-color); transition: transform 0.2s, box-shadow 0.2s; }
        .client-card, .report-item-card.clickable { cursor: pointer; }
        .client-card:hover, .report-item-card.clickable:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.07); }

        .collector-card {
            background-color: var(--surface); border-radius: 12px; padding: 12px;
            display: flex; align-items: center; gap: 15px;
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .collector-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.07); }
        .item-avatar img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .collector-card-main { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; min-width: 0; }
        .collector-card-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .item-info { flex-grow: 1; min-width: 0; }
        .item-name { font-weight: 600; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-subtext { font-size: 0.9em; color: var(--text-secondary); margin-top: 2px; }
        .item-details { text-align: right; }
        .item-detail-value { font-weight: 600; font-size: 1.1em; white-space: nowrap; flex-shrink: 0; }
        .item-tags { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .item-status-tag, .tracking-tag { display: inline-flex; align-items: center; gap: 5px; font-size: 0.75em; font-weight: 600; padding: 4px 8px; border-radius: 12px; }
        .tracking-tag.available { background-color: #3b82f620; color: var(--accent-blue); }
        .tracking-tag.unavailable { background-color: #64748b20; color: var(--text-secondary); }

        .bottom-nav { flex-shrink: 0; background-color: var(--surface); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 10px 0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--text-secondary); text-decoration: none; font-size: 0.8em; padding: 5px 15px; cursor: pointer; }
        .nav-item.active { color: var(--accent-blue); }
        
        .modal-view, .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; }
        .modal-view { background-color: var(--bg); transform: translateX(100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
        .modal-view.active { transform: translateX(0); }
        .modal-overlay { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background-color: var(--surface); padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; }

        .modal-header { display: flex; align-items: center; padding: 15px 20px; background-color: var(--surface); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .modal-header button { background: none; border: none; color: var(--text-primary); cursor: pointer; margin-right: 15px; }
        .modal-title { font-size: 1.2em; font-weight: 600; flex-grow: 1; }
        .modal-content-wrapper { flex-grow: 1; overflow-y: auto; }
        .action-buttons { background-color: var(--surface); border-top: 1px solid var(--border-color); padding: 15px 20px; display: flex; gap: 15px; margin-top: auto; position: sticky; bottom: 0; flex-shrink: 0; }
        .action-buttons button { flex-grow: 1; padding: 15px; font-size: 1em; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background-color: var(--accent-blue); color: white; }
        .btn-secondary { background-color: transparent; color: var(--accent-blue); border: 2px solid var(--accent-blue); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .action-buttons button:disabled { background-color: var(--text-secondary); cursor: not-allowed; opacity: 0.7; }

        .fab { position: fixed; bottom: 90px; right: 20px; width: 60px; height: 60px; background-color: var(--accent-blue); color: white; border-radius: 50%; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 160; }
        .view { display: none; }
        .view.active { display: block; }
        .search-bar-wrapper { position: relative; margin-bottom: 20px; }
        .search-bar-wrapper input { width: 100%; padding: 12px 12px 12px 40px; font-size: 1em; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--surface); color: var(--text-primary); }
        .search-bar-wrapper .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; }
        .toast { background-color: #333; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 0.9em; opacity: 0; transform: translateY(-20px); transition: opacity 0.3s, transform 0.3s; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.toast-error { background-color: var(--danger-color); }

        .status-pending { color: var(--warning-color); } .status-paid { color: var(--accent-green); } .status-late { color: var(--danger-color); }

        .profile-pic-wrapper { position: relative; cursor: pointer; display: inline-block; }
        .profile-pic-wrapper::after { content: '✎'; position: absolute; bottom: 5px; right: 5px; background-color: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        #profile-view-img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent-blue); object-fit: cover; }
        
        #cropper-container { height: calc(100% - 150px); }
        #cropper-container img { max-width: 100%; height: auto; }
        
        .collector-detail-header { display: flex; align-items: center; gap: 15px; background-color: var(--surface); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .collector-detail-header img { width: 64px; height: 64px; border-radius: 50%; object-fit: cover; }
        .collector-detail-info { flex-grow: 1; }
        .collector-detail-info .status-indicator { display: flex; align-items: center; gap: 6px; font-size: 0.9em; font-weight: 500; }
        .collector-detail-info .status-indicator.online::before { content: ''; display: block; width: 8px; height: 8px; border-radius: 50%; background-color: var(--accent-green); }
        .collector-detail-info .status-indicator.offline::before { content: ''; display: block; width: 8px; height: 8px; border-radius: 50%; background-color: var(--text-secondary); }
        .last-seen-info { font-size: 0.8em; color: var(--text-secondary); margin-top: 4px; display: flex; align-items: center; gap: 4px; }
        .header-btn { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 4px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center;}
        .header-btn:hover { background-color: var(--bg); color: var(--accent-blue); }
        
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; background-color: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 20px;}
        .info-grid div { display: flex; flex-direction: column; }
        .info-grid label { font-size: 0.8em; color: var(--text-secondary); margin-bottom: 4px; font-weight: 500; }
        .info-grid p { margin: 0; font-weight: 600; word-break: break-all; }
        .document-item { display: flex; align-items: center; gap: 10px; background-color: var(--surface); padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border-color); text-decoration: none; color: var(--text-primary); transition: background-color 0.2s; }
        .document-item:hover { background-color: var(--bg); }
        .document-item span { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .payment-history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: var(--surface); border-radius: 8px; border: 1px solid var(--border-color); }

        .report-filters { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .report-filters .form-group { flex-grow: 1; margin-bottom: 0; }
        .filter-buttons { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px;}
        .filter-btn { padding: 8px 16px; border: 1px solid var(--border-color); background-color: var(--surface); color: var(--text-secondary); border-radius: 20px; font-weight: 500; cursor: pointer; white-space: nowrap; }
        .filter-btn.active { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }

        .leaflet-popup-content-wrapper { border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        body.dark-mode .leaflet-popup-content-wrapper { background-color: var(--surface); color: var(--text-primary); }
        .leaflet-popup-content { margin: 0; width: 250px; }
        .map-popup-card { font-family: 'Inter', sans-serif; }
        .popup-header { display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border-color); }
        .popup-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-blue); }
        .popup-info { flex-grow: 1; }
        .popup-info .popup-name { font-size: 1.05em; font-weight: 600; color: var(--text-primary); }
        .popup-info .item-status-tag { margin-top: 4px; padding: 3px 8px; font-size: 0.7em; display: inline-flex; }
        .popup-stats { display: grid; grid-template-columns: 1fr 1fr; padding: 12px; gap: 10px; }
        .popup-stats div { display: flex; flex-direction: column; text-align: center; }
        .popup-stats .stat-label { font-size: 0.75em; color: var(--text-secondary); margin-bottom: 2px; text-transform: uppercase; font-weight: 500; }
        .popup-stats .stat-value { font-size: 1.1em; font-weight: 600; color: var(--text-primary); }
        .popup-actions { padding: 8px 12px; border-top: 1px solid var(--border-color); text-align: center; }
        .popup-action-link { text-decoration: none; color: var(--accent-blue); font-weight: 600; font-size: 0.9em; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; }
        .popup-action-link i { width: 14px; height: 14px; }
        
        .progress-card { text-align: center; }
        .progress-circle { position: relative; width: 120px; height: 120px; margin: 0 auto 15px; }
        .progress-circle svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .progress-circle circle { fill: none; stroke-width: 10; }
        .progress-circle .bg-circle { stroke: var(--border-color); }
        .progress-circle .progress-bar { stroke: var(--accent-blue); stroke-linecap: round; transition: stroke-dashoffset 1s ease-out; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5em; font-weight: 700; }
        
        /* --- Settings View Styles --- */
        .settings-section {
            background-color: var(--surface);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        .settings-logo-preview {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .settings-logo-preview img {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }
        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .toggle-switch .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch .switch input { display: none; }
        .toggle-switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .toggle-switch .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .slider { background-color: var(--accent-blue); }
        .toggle-switch input:checked + .slider:before { transform: translateX(22px); }
        .reputation-bar-container { width: 100%; background-color: var(--border-color); border-radius: 8px; height: 16px; overflow: hidden; margin-bottom: 10px; }
        .reputation-bar { height: 100%; border-radius: 8px; width: 0%; transition: width 1s ease-out, background-color 0.5s; }
        .reputation-bar.status-perfect { background-color: var(--accent-green); }
        .reputation-bar.status-good { background-color: var(--warning-color); }
        .reputation-bar.status-bad { background-color: var(--danger-color); }
        .reputation-status { display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .reputation-value { font-weight: 700; }
        .reputation-text { font-weight: 500; padding: 2px 8px; border-radius: 10px; }
        .reputation-text.status-perfect { color: var(--accent-green); background-color: rgba(34, 197, 94, 0.1); }
        .reputation-text.status-good { color: var(--warning-color); background-color: rgba(245, 158, 11, 0.1); }
        .reputation-text.status-bad { color: var(--danger-color); background-color: rgba(239, 68, 68, 0.1); }
    </style>
</head>
<body>
    <div id="splash-screen">
        <img id="splash-logo" src="https://res.cloudinary.com/dc6as14p0/image/upload/v1759611967/LOGO---LUMIX-FINANZAS-REDUCIDO_gc8zow.png" alt="Logo">
    </div>

    <div id="login-view">
        <div class="login-card">
            <div class="logo">
                <img id="login-logo" src="https://res.cloudinary.com/dc6as14p0/image/upload/v1759611967/LOGO---LUMIX-FINANZAS-REDUCIDO_gc8zow.png" alt="Logo">
            </div>
            <h2>Bem-vindo, Administrador</h2>
            <p>Gerencie sua equipe e operações com eficiência.</p>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Usuário</label>
                    <input type="text" id="username" required>
                </div>
                    <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-primary">Acessar Painel</button>
            </form>
        </div>
    </div>

    <div id="app-container"></div>
    <div id="collectorDetailView" class="modal-view"></div>
    <div id="collectorFormModal" class="modal-view"></div>
    <div id="clientDetailModal" class="modal-view"></div>
    <div id="clientFormModal" class="modal-view"></div>
    <div id="cropperModal" class="modal-view"></div>
    <div id="reportOptionsModal" class="modal-overlay"></div>
    <div id="toast-container"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, query, where, setDoc, updateDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBRxJjpH6PBi-GRxOXS8klv-8v91sO4X-Y",
            authDomain: "lumix-financas-app.firebaseapp.com",
            projectId: "lumix-financas-app",
            storageBucket: "lumix-financas-app.appspot.com",
            messagingSenderId: "463777495321",
            appId: "1:463777495321:web:106118f53f56abd206ed88"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const CLOUDINARY_CLOUD_NAME = "dc6as14p0";
        const CLOUDINARY_UPLOAD_PRESET = "lumix-financas-uploads";
        const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

        let allCollectors = [];
        let allClients = [];
        let allExpenses = [];
        let globalSettings = {};
        let currentLang = localStorage.getItem('adminLanguage') || 'pt';
        let mapInstance = null;
        let collectorMarkers = {};
        const money = val => (typeof val !== 'number' || isNaN(val)) ? 'R$ 0,00' : val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const DEFAULT_LOGO_URL = "https://res.cloudinary.com/dc6as14p0/image/upload/v1759611967/LOGO---LUMIX-FINANZAS-REDUCIDO_gc8zow.png";

        // ... código existente ...
    const translations = {
        pt: {
            dashboard: 'Dashboard', reports: 'Relatórios', settings: 'Ajustes', profile: 'Perfil', map: 'Mapa',
            totalCapital: 'Capital Total', activeCollectors: 'Cobradores Ativos', activeClients: 'Clientes Ativos',
            collectionTeam: 'Equipe de Cobrança', addCollector: 'Adicionar Cobrador',
            globalFinances: 'Finanças Globais', distributedCapital: 'Capital Distribuído', expectedToday: 'Ganhos Previstos Hoje',
            fieldValue: 'Valor Total em Campo', grossProfit: 'Lucro Bruto Total',
            clients: 'Clientes', capitalOnHand: 'Capital em Mãos', viewProfile: 'Ver Perfil',
            inOrder: 'Em Ordem', attention: 'Atenção',
            trackingAvailable: 'Rastreamento Disponível', trackingUnavailable: 'Rastreamento Indisponível',
            addNewCollector: 'Adicionar Novo Cobrador', fullName: 'Nome Completo', address: 'Endereço',
            phone: 'Telefone', whatsapp: 'WhatsApp', username: 'Nome de Usuário', password: 'Senha',
            initialCapital: 'Capital Inicial', saveCollector: 'Salvar Cobrador',
            fillFields: 'Preencha todos os campos obrigatórios.', collectorAdded: 'Cobrador adicionado com sucesso!',
            errorSaving: 'Erro ao salvar o cobrador.',
            editCollector: 'Editar Cobrador', saveChanges: 'Salvar Alterações', collectorUpdated: 'Cobrador atualizado com sucesso!',
            editClient: 'Editar Cliente', clientUpdated: 'Cliente atualizado com sucesso!', deleteClient: 'Excluir Cliente', confirmDelete: 'Tem certeza que deseja excluir este cliente? Esta ação não pode ser desfeita.', delete: 'Excluir', clientDeleted: 'Cliente excluído com sucesso!',
            online: 'Online', offline: 'Offline', lastSeen: 'Visto por última vez às',
            collectedToday: 'Recebido Hoje', collectedWeek: 'Recebido na Semana', collectedMonth: 'Recebido no Mês',
            lateClients: 'Clientes Atrasados', status: 'Estado',
            companySettings: 'Configurações da Empresa', companyName: 'Nome da Empresa', companyLogo: 'Logo da Empresa', changeLogo: 'Alterar Logo',
            financialSettings: 'Configurações Financeiras', defaultInterest: 'Taxa de Juros Padrão (%)',
            operationalSettings: 'Configurações Operacionais', gpsTracking: 'Exigir Rastreamento GPS Global', gpsTrackingDesc: 'Ative para que todos os cobradores enviem sua localização.',
            saveSettings: 'Salvar Ajustes', settingsSaved: 'Ajustes salvos com sucesso!',
            fuel: 'Combustível', food: 'Alimentação', rent: 'Aluguel', mechanics: 'Mecânica', other: 'Outros',
            downloadReport: 'Baixar Relatório', selectPeriod: 'Selecione um Período',
            reputationGood: 'Bom', reputationRegular: 'Regular', reputationBad: 'Ruim',
            loanProgress: 'Progresso do Empréstimo',
            totalValue: 'Valor Total',
            totalPaid: 'Total Pago',
            remainingBalance: 'Saldo Devedor',
            installmentValue: 'Valor da Parcela',
            daysShort: ['D','S','T','Q','Q','S','S'],
            all: 'Todos',
            sortByCapital: 'Ordenar por Capital',
            trackingUnavailableShort: 'Rastr. Indisp.',
            capitalDeployed: 'Capital Desdobrado',
            interestGenerated: 'Juros Gerados',
            delinquencyRate: 'Taxa de Inadimplência',
            reputationPerfect: 'Excelente'
        },
        es: {
            dashboard: 'Dashboard', reports: 'Reportes', settings: 'Ajustes', profile: 'Perfil', map: 'Mapa',
            totalCapital: 'Capital Total', activeCollectors: 'Cobradores Activos', activeClients: 'Clientes Activos',
            collectionTeam: 'Equipo de Cobranza', addCollector: 'Añadir Cobrador',
            globalFinances: 'Finanzas Globales', distributedCapital: 'Capital Distribuido', expectedToday: 'Ganancias Previstas Hoy',
            fieldValue: 'Valor Total en Campo', grossProfit: 'Beneficio Bruto Total',
            clients: 'Clientes', capitalOnHand: 'Capital en Mano', viewProfile: 'Ver Perfil',
            inOrder: 'En Orden', attention: 'Atención',
            trackingAvailable: 'Rastreo Disponible', trackingUnavailable: 'Rastreo No Disponible',
            addNewCollector: 'Añadir Nuevo Cobrador', fullName: 'Nombre Completo', address: 'Dirección',
            phone: 'Teléfono', whatsapp: 'WhatsApp', username: 'Nombre de Usuario', password: 'Contraseña',
            initialCapital: 'Capital Inicial', saveCollector: 'Guardar Cobrador',
            fillFields: 'Rellene todos los campos obligatorios.', collectorAdded: '¡Cobrador añadido con éxito!',
            errorSaving: 'Error al guardar el cobrador.',
            editCollector: 'Editar Cobrador', saveChanges: 'Guardar Cambios', collectorUpdated: '¡Cobrador actualizado con éxito!',
            editClient: 'Editar Cliente', clientUpdated: '¡Cliente actualizado con éxito!', deleteClient: 'Eliminar Cliente', confirmDelete: '¿Está seguro de que desea eliminar este cliente? Esta acción no se puede deshacer.', delete: 'Eliminar', clientDeleted: '¡Cliente eliminado con éxito!',
            online: 'En línea', offline: 'Desconectado', lastSeen: 'Última vez visto a las',
            collectedToday: 'Recibido Hoy', collectedWeek: 'Recibido en la Semana', collectedMonth: 'Recibido en el Mes',
            lateClients: 'Clientes Atrasados', status: 'Estado',
            companySettings: 'Configuración de la Empresa', companyName: 'Nombre de la Empresa', companyLogo: 'Logo de la Empresa', changeLogo: 'Cambiar Logo',
            financialSettings: 'Configuración Financiera', defaultInterest: 'Tasa de Interés Predeterminada (%)',
            operationalSettings: 'Configuración Operacional', gpsTracking: 'Requerir Rastreo GPS Global', gpsTrackingDesc: 'Activa para que todos los cobradores envíen su ubicación.',
            saveSettings: 'Guardar Ajustes', settingsSaved: '¡Ajustes guardados con éxito!',
            fuel: 'Combustible', food: 'Alimentación', rent: 'Alquiler', mechanics: 'Mecánica', other: 'Otros',
            downloadReport: 'Descargar Reporte', selectPeriod: 'Seleccione un Período',
            last24h: 'Últimas 24h', last48h: 'Últimas 48h', lastWeek: 'Última Semana', lastMonth: 'Último Mes', last3Months: 'Últimos 3 Meses', allTime: 'Desde el Inicio',
            capitalDeployed: 'Capital Desplegado', interestGenerated: 'Intereses Generados', delinquencyRate: 'Tasa de Morosidad',
            portfolioSummary: 'Resumen de Cartera', clientsOnTime: 'Clientes al Día', completedLoans: 'Préstamos Completados',
            reputationPerfect: 'Excelente', reputationGood: 'Bueno', reputationRegular: 'Regular', reputationBad: 'Mala',
            loanProgress: 'Progreso del Préstamo',
            totalValue: 'Valor Total',
            totalPaid: 'Total Pagado',
            remainingBalance: 'Saldo Deudor',
            installmentValue: 'Valor de la Cuota',
            daysShort: ['D','L','M','M','J','V','S'],
            all: 'Todos',
            sortByCapital: 'Ordenar por Capital',
            trackingUnavailableShort: 'Rastreo No Disp.'
        },
        en: {
            dashboard: 'Dashboard', reports: 'Reports', settings: 'Settings', profile: 'Profile', map: 'Map',
            totalCapital: 'Total Capital', activeCollectors: 'Active Collectors', activeClients: 'Active Clients',
            collectionTeam: 'Collection Team', addCollector: 'Add Collector',
            globalFinances: 'Global Finances', distributedCapital: 'Distributed Capital', expectedToday: 'Expected Earnings Today',
            fieldValue: 'Total Field Value', grossProfit: 'Total Gross Profit',
            clients: 'Clients', capitalOnHand: 'Capital on Hand', viewProfile: 'View Profile',
            inOrder: 'In Order', attention: 'Attention',
            trackingAvailable: 'Tracking Available', trackingUnavailable: 'Tracking Unavailable',
            addNewCollector: 'Add New Collector', fullName: 'Full Name', address: 'Address',
            phone: 'Phone', whatsapp: 'WhatsApp', username: 'Username', password: 'Password',
            initialCapital: 'Initial Capital', saveCollector: 'Save Collector',
            fillFields: 'Please fill all required fields.', collectorAdded: 'Collector added successfully!',
            errorSaving: 'Error saving collector.',
            editCollector: 'Edit Collector', saveChanges: 'Save Changes', collectorUpdated: 'Collector updated successfully!',
            editClient: 'Edit Client', clientUpdated: 'Client updated successfully!', deleteClient: 'Delete Client', confirmDelete: 'Are you sure you want to delete this client? This action cannot be undone.', delete: 'Delete', clientDeleted: 'Client deleted successfully!',
            online: 'Online', offline: 'Offline', lastSeen: 'Last seen at',
            collectedToday: 'Received Today', collectedWeek: 'Received this Week', collectedMonth: 'Received this Month',
            lateClients: 'Late Clients', status: 'Status',
            companySettings: 'Company Settings', companyName: 'Company Name', companyLogo: 'Company Logo', changeLogo: 'Change Logo',
            financialSettings: 'Financial Settings', defaultInterest: 'Default Interest Rate (%)',
            operationalSettings: 'Operational Settings', gpsTracking: 'Require Global GPS Tracking', gpsTrackingDesc: 'Enable to require all collectors to send their location.',
            saveSettings: 'Save Settings', settingsSaved: 'Settings saved successfully!',
            fuel: 'Fuel', food: 'Food', rent: 'Rent', mechanics: 'Mechanics', other: 'Other',
            downloadReport: 'Download Report', selectPeriod: 'Select a Period',
            last24h: 'Last 24h', last48h: 'Last 48h', lastWeek: 'Last Week', lastMonth: 'Last Month', last3Months: 'Last 3 Months', allTime: 'All Time',
            capitalDeployed: 'Capital Deployed', interestGenerated: 'Interest Generated', delinquencyRate: 'Delinquency Rate',
            portfolioSummary: 'Portfolio Summary', clientsOnTime: 'On-Time Clients', completedLoans: 'Completed Loans',
            reputationPerfect: 'Excellent', reputationGood: 'Good', reputationRegular: 'Regular', reputationBad: 'Bad',
            loanProgress: 'Loan Progress',
            totalValue: 'Total Value',
            totalPaid: 'Total Paid',
            remainingBalance: 'Remaining Balance',
            installmentValue: 'Installment Value',
            daysShort: ['S','M','T','W','T','F','S'],
            all: 'All',
            sortByCapital: 'Sort by Capital',
            trackingUnavailableShort: 'Track. Unavail.'
        }
    };
// ... código existente ...

        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'toast-error' : ''}`;
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, 3500);
        }

        function renderMainLayout() {
            document.getElementById('app-container').innerHTML = `
                <header class="main-header">
                    <div class="logo">
                        <img id="header-logo" src="${DEFAULT_LOGO_URL}" alt="Logo">
                        <span id="header-logo-text" class="logo-text">LUMIX Admin</span>
                    </div>
                    <div class="header-controls">
                        <div style="position: relative;">
                            <button class="header-btn" id="lang-toggle" title="Mudar idioma"><i data-lucide="globe"></i></button>
                            <div class="lang-dropdown" id="lang-dropdown" style="display: none;">
                                <button data-lang="pt">Português</button>
                                <button data-lang="es">Español</button>
                                <button data-lang="en">English</button>
                            </div>
                        </div>
                        <button class="header-btn" id="theme-toggle"><i data-lucide="moon"></i></button>
                        <div class="profile"><img src="https://placehold.co/80x80/3b82f6/FFFFFF?text=A" alt="Foto do Admin"></div>
                    </div>
                </header>
                <main>
                    <div id="dashboard-view" class="view active container">
                        <section class="kpi-grid">
                            <div class="kpi-card">
                                <h3 class="kpi-title" data-lang-key="totalCapital"><i data-lucide="gem"></i></h3>
                                <p class="kpi-value" id="kpi-total-capital"></p>
                            </div>
                            <div class="kpi-card">
                                <h3 class="kpi-title" data-lang-key="activeCollectors"><i data-lucide="users"></i></h3>
                                <p class="kpi-value" id="kpi-active-collectors"></p>
                            </div>
                                <div class="kpi-card">
                                <h3 class="kpi-title" data-lang-key="activeClients"><i data-lucide="user-check"></i></h3>
                                <p class="kpi-value" id="kpi-active-clients"></p>
                            </div>
                        </section>
                        <section>
                            <h2 class="section-title" data-lang-key="collectionTeam"></h2>
                            <div class="search-bar-wrapper">
                                <input type="text" id="collector-search-input" placeholder="Buscar Cobrador...">
                                <i class="icon" data-lucide="search"></i>
                            </div>
                            <div class="filter-buttons" style="justify-content: space-between; flex-wrap: wrap;">
                                <div>
                                    <button class="filter-btn active" data-filter="all" data-lang-key="all"></button>
                                    <button class="filter-btn" data-filter="inOrder"><i data-lucide="check-circle" style="width:14px; height:14px;"></i> <span data-lang-key="inOrder"></span></button>
                                    <button class="filter-btn" data-filter="attention"><i data-lucide="alert-triangle" style="width:14px; height:14px;"></i> <span data-lang-key="attention"></span></button>
                                    <button class="filter-btn" data-filter="trackingUnavailable"><i data-lucide="wifi-off" style="width:14px; height:14px;"></i> <span data-lang-key="trackingUnavailableShort"></span></button>
                                </div>
                                <div>
                                    <button class="filter-btn" data-sort="capital"><i data-lucide="arrow-down-up" style="width:14px; height:14px;"></i> <span data-lang-key="sortByCapital"></span></button>
                                </div>
                            </div>
                            <div class="item-list" id="collectors-list"></div>
                        </section>
                    </div>
                    <div id="map-view" class="view" style="height:100%; padding:0;">
                        <div id="map-container" style="height:100%; width:100%;"></div>
                    </div>
                    <div id="reports-view" class="view container">
                        <h1 class="section-title" data-lang-key="reports"></h1>
                        <div class="report-filters">
                                <div class="form-group">
                                <label>Filtrar por Cobrador</label>
                                <select id="report-collector-filter"></select>
                            </div>
                        </div>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-period="today">Hoje</button>
                            <button class="filter-btn" data-period="week">Esta Semana</button>
                            <button class="filter-btn" data-period="month">Este Mês</button>
                            <button class="filter-btn" data-period="all">Desde o Início</button>
                        </div>
                        <div id="report-results"></div>
                    </div>
                    <div id="settings-view" class="view container">
                        <h1 class="section-title" data-lang-key="settings"></h1>
                        <div class="settings-section">
                            <h2 class="section-title" data-lang-key="companySettings"></h2>
                            <div class="form-group">
                                <label data-lang-key="companyName"></label>
                                <input type="text" id="settings-company-name">
                            </div>
                            <div class="form-group">
                                <label data-lang-key="companyLogo"></label>
                                <div class="settings-logo-preview">
                                    <img id="settings-logo-preview" src="${DEFAULT_LOGO_URL}">
                                    <label for="settings-logo-input" class="btn-secondary" style="cursor:pointer; text-align:center;"><i data-lucide="upload"></i> <span data-lang-key="changeLogo"></span></label>
                                    <input type="file" id="settings-logo-input" accept="image/*" style="display:none;">
                                </div>
                            </div>
                        </div>
                        <div class="settings-section">
                            <h2 class="section-title" data-lang-key="financialSettings"></h2>
                            <div class="form-group">
                                <label data-lang-key="defaultInterest"></label>
                                <input type="number" id="settings-default-interest" step="0.1">
                            </div>
                        </div>
                         <div class="settings-section">
                            <h2 class="section-title" data-lang-key="operationalSettings"></h2>
                            <div class="form-group">
                                <div class="toggle-switch">
                                    <div>
                                        <label for="settings-gps-toggle" style="font-weight: 600;" data-lang-key="gpsTracking"></label>
                                        <p style="font-size: 0.9em; color: var(--text-secondary); margin: 4px 0 0;" data-lang-key="gpsTrackingDesc"></p>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox" id="settings-gps-toggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="action-buttons" style="position: static; margin-top: 20px;">
                            <button id="save-settings-btn" class="btn-primary" disabled><i data-lucide="save"></i> <span data-lang-key="saveSettings"></span></button>
                        </div>
                    </div>
                    <div id="profile-view" class="view container">
                         <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 30px;">
                            <label for="admin-profile-pic-input" class="profile-pic-wrapper">
                                <img id="profile-view-img" src="https://placehold.co/100x100/3b82f6/FFFFFF?text=A" alt="Foto do Admin">
                            </label>
                            <input type="file" id="admin-profile-pic-input" accept="image/*" style="display: none;">
                            <h2 style="margin: 15px 0 0; font-size: 1.5em;">Administrador</h2>
                            <p style="margin: 5px 0 0; color: var(--text-secondary);">Painel de Controle</p>
                        </div>
                        <section>
                             <h2 class="section-title" data-lang-key="globalFinances"></h2>
                             <div class="kpi-grid">
                                 <div class="kpi-card">
                                     <h3 class="kpi-title" data-lang-key="distributedCapital"><i data-lucide="landmark"></i></h3>
                                     <p class="kpi-value" id="kpi-distributed-capital"></p>
                                 </div>
                                 <div class="kpi-card">
                                     <h3 class="kpi-title" data-lang-key="expectedToday"><i data-lucide="trending-up"></i></h3>
                                     <p class="kpi-value" id="kpi-expected-today"></p>
                                 </div>
                                 <div class="kpi-card">
                                     <h3 class="kpi-title" data-lang-key="fieldValue"><i data-lucide="circle-dollar-sign"></i></h3>
                                     <p class="kpi-value" id="kpi-field-value"></p>
                                 </div>
                                 <div class="kpi-card">
                                     <h3 class="kpi-title" data-lang-key="grossProfit"><i data-lucide="bar-chart-2"></i></h3>
                                     <p class="kpi-value" id="kpi-gross-profit"></p>
                                 </div>
                             </div>
                        </section>
                    </div>
                </main>
                <nav class="bottom-nav">
                    <a class="nav-item active" data-view="dashboard"><i data-lucide="layout-dashboard"></i><span data-lang-key="dashboard"></span></a>
                    <a class="nav-item" data-view="map"><i data-lucide="map"></i><span data-lang-key="map"></span></a>
                    <a class="nav-item" data-view="reports"><i data-lucide="file-text"></i><span data-lang-key="reports"></span></a>
                    <a class="nav-item" data-view="settings"><i data-lucide="settings"></i><span data-lang-key="settings"></span></a>
                    <a class="nav-item" data-view="profile"><i data-lucide="user"></i><span data-lang-key="profile"></span></a>
                </nav>
                <button class="fab" id="addCollectorBtn" title="Adicionar Cobrador"><i data-lucide="plus"></i></button>
            `;
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp || !timestamp.seconds) return '';
            const date = timestamp.toDate();
            return date.toLocaleTimeString(currentLang === 'pt' ? 'pt-BR' : 'es-ES', { hour: '2-digit', minute: '2-digit' });
        }

        const nationalHolidays = [ '01/01', '21/04', '01/05', '07/09', '12/10', '02/11', '15/11', '25/12' ];

        function calculateLatePaymentDays(client) {
            if (!client || (client.paid >= client.totalLoan)) return 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let lastRelevantDate;
            if (client.history && client.history.length > 0) {
                const sortedHistory = [...client.history]
                    .filter(h => h.date?.seconds && h.status !== 'pending_verification')
                    .sort((a, b) => b.date.seconds - a.date.seconds);
                if (sortedHistory.length > 0) lastRelevantDate = new Date(sortedHistory[0].date.seconds * 1000);
            }
            if (!lastRelevantDate) {
                if (client.startDate?.seconds) {
                    lastRelevantDate = new Date(client.startDate.seconds * 1000);
                } else {
                    return 0;
                }
            }
            
            lastRelevantDate.setHours(0, 0, 0, 0);
            if (lastRelevantDate >= today) return 0;

            let workingDaysToPay = 0;
            let checkDate = new Date(lastRelevantDate);
            while (checkDate < today) {
                checkDate.setDate(checkDate.getDate() + 1);
                const dayOfWeek = checkDate.getDay();
                const formattedDate = `${String(checkDate.getDate()).padStart(2, '0')}/${String(checkDate.getMonth() + 1).padStart(2, '0')}`;
                const isHoliday = nationalHolidays.includes(formattedDate);
                const isPaymentDay = (client.paymentDays || []).includes(dayOfWeek);
                if (!isHoliday && isPaymentDay) {
                    workingDaysToPay++;
                }
            }
            return workingDaysToPay > 0 ? workingDaysToPay : 0;
        }

        function calculateCollectorStatus(collectorId) {
            const collectorClients = allClients.filter(c => c.collectorId === collectorId);
            if (collectorClients.length === 0) {
                return { textKey: 'inOrder', color: 'var(--accent-green)', icon: 'check-circle' };
            }
            const lateClients = collectorClients.filter(c => c.status === 'late').length;
            const latePercentage = (lateClients / collectorClients.length) * 100;

            if (latePercentage === 0) {
                return { textKey: 'inOrder', color: 'var(--accent-green)', icon: 'check-circle' };
            } else if (latePercentage <= 20) {
                return { textKey: 'attention', color: 'var(--warning-color)', icon: 'alert-triangle' };
            } else {
                return { textKey: 'attention', color: 'var(--danger-color)', icon: 'alert-octagon' };
            }
        }

        function updateDashboard() {
            if(!document.getElementById('kpi-total-capital')) return;
            const totalCapital = allCollectors.reduce((sum, c) => sum + (c.startingCapital || 0), 0) + allClients.reduce((sum, cl) => sum + (cl.paid || 0), 0) - allClients.reduce((sum, cl) => sum + (cl.totalLoan / (1 + (cl.interestRate || 0)/100)), 0);

            document.getElementById('kpi-total-capital').textContent = money(totalCapital);
            document.getElementById('kpi-active-collectors').textContent = allCollectors.length;
            document.getElementById('kpi-active-clients').textContent = allClients.length;

            const listContainer = document.getElementById('collectors-list');
            if(!listContainer) return;

            // --- GET FILTERS AND SORTING ---
            const searchInput = document.getElementById('collector-search-input');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const activeStatusFilter = document.querySelector('#dashboard-view .filter-btn[data-filter].active');
            const statusFilter = activeStatusFilter ? activeStatusFilter.dataset.filter : 'all';
            const activeSortBtn = document.querySelector('#dashboard-view .filter-btn[data-sort].active');
            const sortBy = activeSortBtn ? activeSortBtn.dataset.sort : null;
            
            // --- 1. SEARCH FILTER ---
            let filteredCollectors = allCollectors.filter(collector => 
                collector.name.toLowerCase().includes(searchTerm)
            );
            
            // --- 2. STATUS FILTER ---
            if (statusFilter !== 'all') {
                if (statusFilter === 'trackingUnavailable') {
                    filteredCollectors = filteredCollectors.filter(collector => !collector.isRealtimeTrackingActive);
                } else {
                    filteredCollectors = filteredCollectors.filter(collector => {
                        const status = calculateCollectorStatus(collector.id);
                        return status.textKey === statusFilter;
                    });
                }
            }
            
            // --- 3. PREPARE DATA FOR SORTING & RENDERING ---
            let collectorsWithData = filteredCollectors.map(collector => {
                const collectorClients = allClients.filter(c => c.collectorId === collector.id);
                const capitalOnHand = (collector.startingCapital || 0) + collectorClients.reduce((sum, c) => sum + (c.paid || 0), 0) - collectorClients.reduce((sum, c) => sum + (c.totalLoan / (1 + (c.interestRate || 0)/100)), 0);
                return { ...collector, capitalOnHand, clientCount: collectorClients.length };
            });
            
            // --- 4. SORTING ---
            if (sortBy === 'capital') {
                collectorsWithData.sort((a, b) => b.capitalOnHand - a.capitalOnHand);
            }

            if (collectorsWithData.length === 0) {
                listContainer.innerHTML = `<p>Nenhum cobrador encontrado.</p>`;
                return;
            }

            listContainer.innerHTML = collectorsWithData.map(collector => {
                const placeholderUrl = `https://placehold.co/96x96/0f172a/FFFFFF?text=${(collector.name || 'C').charAt(0)}`;
                const status = calculateCollectorStatus(collector.id);
                const isTrackingActive = collector.isRealtimeTrackingActive;

                return `
                    <div class="collector-card" data-collector-id="${collector.id}">
                        <div class="item-avatar">
                            <img src="${collector.profilePictureUrl || placeholderUrl}" alt="Foto do Cobrador">
                        </div>
                        <div class="collector-card-main">
                            <div class="collector-card-top">
                                <div class="item-info">
                                    <h4 class="item-name">${collector.name}</h4>
                                    <p class="item-subtext">${collector.clientCount} <span data-lang-key="clients"></span></p>
                                </div>
                                <div class="item-details">
                                    <span class="item-detail-value">${money(collector.capitalOnHand)}</span>
                                </div>
                            </div>
                            <div class="item-tags">
                                <div class="item-status-tag" style="background-color: ${status.color}20; color: ${status.color};">
                                    <i data-lucide="${status.icon}" style="width: 14px; height: 14px;"></i>
                                    <span data-lang-key="${status.textKey}"></span>
                                </div>
                                <div class="tracking-tag ${isTrackingActive ? 'available' : 'unavailable'}">
                                    <i data-lucide="${isTrackingActive ? 'map' : 'wifi-off'}" style="width: 14px; height: 14px;"></i>
                                    <span data-lang-key="${isTrackingActive ? 'trackingAvailable' : 'trackingUnavailable'}"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons({nodes: listContainer.querySelectorAll('[data-lucide]')});

            applyLanguage(currentLang);
        }
        
        function updateProfileView() {
            if(!document.getElementById('kpi-distributed-capital')) return;
            const distributedCapital = allCollectors.reduce((sum, c) => sum + (c.startingCapital || 0), 0);
            
            const today = new Date();
            const dayOfWeek = today.getDay();
            const expectedToday = allClients.filter(c => (c.paymentDays || []).includes(dayOfWeek) && (c.status === 'pending' || c.status === 'late')).reduce((sum, c) => sum + c.amount, 0);

            const fieldValue = allClients.reduce((sum, c) => sum + ((c.totalLoan || 0) - (c.paid || 0)), 0);

            const totalPaid = allClients.reduce((sum, c) => sum + (c.paid || 0), 0);
            const totalPrincipal = allClients.reduce((sum, c) => sum + ((c.totalLoan || 0) / (1 + (c.interestRate || 0)/100)), 0);
            const grossProfit = totalPaid - totalPrincipal;

            document.getElementById('kpi-distributed-capital').textContent = money(distributedCapital);
            document.getElementById('kpi-expected-today').textContent = money(expectedToday);
            document.getElementById('kpi-field-value').textContent = money(fieldValue);
            document.getElementById('kpi-gross-profit').textContent = money(grossProfit);
        }
        
        function showCollectorDetails(collectorId) {
            const detailView = document.getElementById('collectorDetailView');
            const collector = allCollectors.find(c => c.id === collectorId);
            const clients = allClients.filter(c => c.collectorId === collectorId);
            if (!collector) return;

            const mapView = document.getElementById('map-view');
            if (mapView && mapView.classList.contains('active')) {
                mapView.classList.remove('active');
                document.getElementById('dashboard-view').classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                const dashboardNavItem = document.querySelector('.nav-item[data-view="dashboard"]');
                if (dashboardNavItem) {
                    dashboardNavItem.classList.add('active');
                }
            }
            
            const placeholderUrl = `https://placehold.co/128x128/0f172a/FFFFFF?text=${(collector.name || 'C').charAt(0)}`;
            const isTrackingActive = collector.isRealtimeTrackingActive;
            const lastSeenTime = formatTimestamp(collector.lastLocationUpdate);

            const collectorExpenses = allExpenses.filter(e => e.collectorId === collectorId);
            const totalPaidByCollector = clients.reduce((sum, c) => sum + (c.paid || 0), 0);
            const totalPrincipalLoanedByCollector = clients.reduce((sum, c) => sum + ((c.totalLoan || 0) / (1 + (c.interestRate || 0)/100)), 0);
            const totalExpensesByCollector = collectorExpenses.reduce((sum, e) => sum + (e.value || 0), 0);
            const capitalOnHand = (collector.startingCapital || 0) + totalPaidByCollector - totalPrincipalLoanedByCollector - totalExpensesByCollector;

            let dailyCollected = 0, weeklyCollected = 0, monthlyCollected = 0;
            const now = new Date();
            const todayStart = new Date(new Date().setHours(0, 0, 0, 0));
            const weekStart = new Date(todayStart);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

            clients.forEach(c => {
                (c.history || []).forEach(h => {
                    if (h.date && h.date.seconds) {
                        const paymentDate = new Date(h.date.seconds * 1000);
                        if (paymentDate >= todayStart) dailyCollected += h.amount;
                        if (paymentDate >= weekStart) weeklyCollected += h.amount;
                        if (paymentDate >= monthStart) monthlyCollected += h.amount;
                    }
                });
            });

            const status = calculateCollectorStatus(collectorId);
            const lateClientsCount = clients.filter(c => c.status === 'late').length;


            detailView.innerHTML = `
                <header class="modal-header">
                    <button id="closeDetailView"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title">${collector.name}</span>
                    <button id="editCollectorBtn" class="header-btn" data-collector-id="${collectorId}"><i data-lucide="edit"></i></button>
                </header>
                <div class="modal-content-wrapper container">
                    <div class="collector-detail-header">
                        <img src="${collector.profilePictureUrl || placeholderUrl}" alt="Foto do Cobrador">
                        <div class="collector-detail-info">
                            <h3 class="item-name" style="margin-bottom: 5px;">${collector.name}</h3>
                            <div class="status-indicator ${isTrackingActive ? 'online' : 'offline'}">
                                <span data-lang-key="${isTrackingActive ? 'online' : 'offline'}"></span>
                            </div>
                            ${!isTrackingActive && lastSeenTime ? `
                                <div class="last-seen-info">
                                    <i data-lucide="clock" style="width:12px; height:12px;"></i>
                                    <span data-lang-key="lastSeen"></span> ${lastSeenTime}
                                </div>` : ''
                            }
                        </div>
                        <div style="margin-left: auto; display: flex; gap: 8px;">
                            ${collector.whatsapp ? `
                                <a href="https://wa.me/${collector.whatsapp.replace(/\D/g, '')}" target="_blank" class="header-btn" title="Enviar mensagem via WhatsApp">
                                    <svg viewBox="0 0 16 16" width="24" height="24" fill="#25D366" xmlns="http://www.w3.org/2000/svg"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                                </a>
                            ` : `
                                <button class="header-btn" title="WhatsApp não disponível" disabled style="cursor: not-allowed;">
                                    <svg viewBox="0 0 16 16" width="24" height="24" fill="var(--text-secondary)" xmlns="http://www.w3.org/2000/svg" style="opacity: 0.4;"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                                </button>
                            `}
                            <button class="header-btn collector-map-btn" data-collector-id="${collectorId}" title="Ver no mapa">
                                <i data-lucide="map-pin" style="width: 24px; height: 24px;"></i>
                            </button>
                        </div>
                    </div>

                    <section class="kpi-grid" style="grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="kpi-card">
                            <h3 class="kpi-title" data-lang-key="capitalOnHand"><i data-lucide="wallet"></i></h3>
                            <p class="kpi-value">${money(capitalOnHand)}</p>
                        </div>
                        <div class="kpi-card">
                            <h3 class="kpi-title" data-lang-key="status"><i data-lucide="${status.icon}"></i></h3>
                            <p class="kpi-value" style="color: ${status.color}; font-size: 1.2em;">${translations[currentLang][status.textKey]}</p>
                        </div>
                        <div class="kpi-card">
                            <h3 class="kpi-title" data-lang-key="lateClients"><i data-lucide="user-x"></i></h3>
                            <p class="kpi-value" style="color: var(--danger-color);">${lateClientsCount}</p>
                        </div>
                    </section>

                    <section style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px; margin-bottom: 20px;">
                        <div class="kpi-card" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px;">
                            <h3 class="kpi-title" data-lang-key="collectedToday" style="margin: 0; font-size: 0.95em;"><i data-lucide="sun" style="width: 16px; height: 16px;"></i></h3>
                            <p class="kpi-value" style="font-size: 1.2em; color: var(--accent-green);">${money(dailyCollected)}</p>
                        </div>
                        <div class="kpi-card" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px;">
                            <h3 class="kpi-title" data-lang-key="collectedWeek" style="margin: 0; font-size: 0.95em;"><i data-lucide="calendar" style="width: 16px; height: 16px;"></i></h3>
                            <p class="kpi-value" style="font-size: 1.2em; color: var(--accent-green);">${money(weeklyCollected)}</p>
                        </div>
                        <div class="kpi-card" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px;">
                            <h3 class="kpi-title" data-lang-key="collectedMonth" style="margin: 0; font-size: 0.95em;"><i data-lucide="calendar-days" style="width: 16px; height: 16px;"></i></h3>
                            <p class="kpi-value" style="font-size: 1.2em; color: var(--accent-green);">${money(monthlyCollected)}</p>
                        </div>
                    </section>

                    <h2 class="section-title">Clientes de ${collector.name}</h2>
                    <div class="item-list">
                        ${clients.length > 0 ? clients.map(client => {
                                const statusClass = `status-${client.status || 'pending'}`;
                                const nameInitial = (client.name || 'C').charAt(0).toUpperCase();
                                const placeholderUrl = `https://placehold.co/80x80/3b82f6/FFFFFF?text=${nameInitial}`;
                                const photoUrl = client.profilePictureUrl || placeholderUrl;
                                return `
                                <div class="client-card" data-client-id="${client.id}">
                                    <div class="item-avatar">
                                        <img src="${photoUrl}" alt="Foto do Cliente">
                                    </div>
                                    <div class="item-info">
                                        <h4 class="item-name">${client.name}</h4>
                                        <p class="item-subtext">${client.address || 'Endereço não informado'}</p>
                                    </div>
                                    <div class="item-details">
                                        <span class="item-detail-value">${money(client.amount)}</span>
                                        <p class="item-subtext ${statusClass}" style="text-transform: capitalize;">${client.status || 'Pendente'}</p>
                                    </div>
                                </div>
                            `}).join('') : '<p>Nenhum cliente para este cobrador.</p>'
                        }
                    </div>
                </div>
                    
                 <div class="action-buttons">
                    <button id="download-report-btn" data-collector-id="${collectorId}" class="btn-secondary"><i data-lucide="download"></i> <span data-lang-key="downloadReport"></span></button>
                </div>
            `;
            detailView.classList.add('active');
            lucide.createIcons({nodes: detailView.querySelectorAll('[data-lucide]')});
            applyLanguage(currentLang);

            detailView.querySelector('#closeDetailView').addEventListener('click', () => detailView.classList.remove('active'));

            detailView.querySelector('.item-list').addEventListener('click', (e) => {
                const clientCard = e.target.closest('.client-card');
                if (clientCard) {
                    showClientDetails(clientCard.dataset.clientId);
                }
            });
            
            detailView.querySelector('#editCollectorBtn').addEventListener('click', (e) => {
                showCollectorFormModal(e.currentTarget.dataset.collectorId);
            });
            
            detailView.querySelector('#download-report-btn').addEventListener('click', (e) => {
                showReportOptionsModal(e.currentTarget.dataset.collectorId);
            });

            detailView.querySelector('.collector-map-btn').addEventListener('click', (e) => {
                const collectorId = e.currentTarget.dataset.collectorId;
                focusOnCollector(collectorId);
            });
        }
        
        function showClientDetails(clientId) {
            const client = allClients.find(c => c.id === clientId);
            if (!client) {
                showToast('Cliente não encontrado.', true);
                return;
            }

            const detailModal = document.getElementById('clientDetailModal');
            const historyHtml = (client.history && client.history.length > 0) ? 
                [...client.history].sort((a,b) => b.date.seconds - a.date.seconds).map(p => `
                    <div class="payment-history-item">
                        <span>${new Date(p.date.seconds * 1000).toLocaleDateString()}</span>
                        <strong>${money(p.amount)}</strong>
                    </div>
                `).join('') : '<p>Nenhum histórico de pagamento.</p>';
            
            const docsHtml = (client.documents && client.documents.length > 0) ?
                client.documents.map(doc => `
                    <a href="${doc.url}" target="_blank" class="document-item">
                        <i data-lucide="file-text"></i>
                        <span>${doc.name}</span>
                        <i data-lucide="external-link"></i>
                    </a>
                `).join('') : '<p>Nenhum documento anexado.</p>';
            
            const remainingBalance = (client.totalLoan || 0) - (client.paid || 0);
            const totalInstallments = client.installments ? client.installments.split('/')[1] : 'N/A';
            const paidInstallments = (client.history || []).filter(h => h.status !== 'pending_verification').length;
            
            const progressPercentage = totalInstallments > 0 && totalInstallments !== 'N/A' ? (paidInstallments / totalInstallments) * 100 : 0;
            const circleCircumference = 2 * Math.PI * 54;
            const strokeDashoffset = circleCircumference - (progressPercentage / 100) * circleCircumference;

            const nameInitial = (client.name || 'C').charAt(0).toUpperCase();
            const placeholderUrl = `https://placehold.co/100x100/3b82f6/FFFFFF?text=${nameInitial}`;
            const photoUrl = client.profilePictureUrl || placeholderUrl;

            const lateDays = calculateLatePaymentDays(client);
            const score = Math.max(0, 10 - lateDays);
            
            let reputationStatusKey = 'reputationBad';
            if (score === 10) reputationStatusKey = 'reputationPerfect';
            else if (score >= 7) reputationStatusKey = 'reputationGood';
            else if (score >= 3) reputationStatusKey = 'reputationRegular';

            let barStatusClass = 'status-bad';
            if (score === 10) barStatusClass = 'status-perfect';
            else if (score >= 7) barStatusClass = 'status-good';
            else if (score >= 3) barStatusClass = 'status-regular';
            const paymentDaysText = (client.paymentDays || []).map(dayIndex => translations[currentLang].daysShort[dayIndex] || '').join(', ');

            detailModal.innerHTML = `
                <header class="modal-header">
                    <button id="closeClientDetail"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title">${client.name}</span>
                    <button id="editClientBtn" data-client-id="${client.id}" class="header-btn"><i data-lucide="edit"></i></button>
                </header>
                <div class="modal-content-wrapper container">
                <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                    <img src="${photoUrl}" alt="Foto do Cliente" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent-blue);">
                </div>

                <div class="kpi-card" style="margin-bottom: 20px; text-align: center;">
                    <h3 class="kpi-title" style="justify-content: center;" data-lang-key="loanProgress"></h3>
                    <div class="progress-circle">
                        <svg><circle class="bg-circle" cx="60" cy="60" r="54"></circle><circle class="progress-bar" cx="60" cy="60" r="54" style="stroke-dasharray: ${circleCircumference}; stroke-dashoffset: ${strokeDashoffset};"></circle></svg>
                        <div class="progress-text">${paidInstallments}/${totalInstallments}</div>
                    </div>
                </div>

                <div class="kpi-card" style="margin-bottom: 20px;">
                    <h3 class="kpi-title">Reputação</h3>
                    <div class="reputation-bar-container">
                        <div class="reputation-bar ${barStatusClass}" style="width: ${score * 10}%"></div>
                    </div>
                    <div class="reputation-status">
                        <span class="reputation-value">${score} / 10</span>
                        <span class="reputation-text ${barStatusClass}">${translations[currentLang][reputationStatusKey]}</span>
                    </div>
                </div>
                <section style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                    <div class="kpi-card" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px;">
                        <h3 class="kpi-title" data-lang-key="totalValue" style="margin: 0; font-size: 0.95em;"></h3>
                        <p class="kpi-value" style="font-size: 1.2em;">${money(client.totalLoan)}</p>
                    </div>
                    <div class="kpi-card" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px;">
                        <h3 class="kpi-title" data-lang-key="totalPaid" style="margin: 0; font-size: 0.95em;"></h3>
                        <p class="kpi-value" style="font-size: 1.2em; color: var(--accent-green);">${money(client.paid)}</p>
                    </div>
                    <div class="kpi-card" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px;">
                        <h3 class="kpi-title" data-lang-key="installmentValue" style="margin: 0; font-size: 0.95em;"></h3>
                        <p class="kpi-value" style="font-size: 1.2em; color: var(--accent-blue);">${money(client.amount)}</p>
                    </div>
                    <div class="kpi-card" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px;">
                        <h3 class="kpi-title" data-lang-key="remainingBalance" style="margin: 0; font-size: 0.95em;"></h3>
                        <p class="kpi-value" style="font-size: 1.2em; color: var(--danger-color);">${money(remainingBalance)}</p>
                    </div>
                </section>

                    <section>
                        <h2 class="section-title">Informações do Cliente</h2>
                        <div class="info-grid">
                            <div><label>Endereço</label><p>${client.address || 'N/A'}</p></div>
                            <div><label>Cidade</label><p>${client.city || 'N/A'}</p></div>
                            <div><label>Telefone (WhatsApp)</label><p>${client.whatsapp || 'Não informado'}</p></div>
                            <div><label>Telefone Opcional</label><p>${client.phone || 'Não informado'}</p></div>
                            <div><label>Dias de Pagamento</label><p>${paymentDaysText}</p></div>
                            <div><label>Valor da Parcela</label><p>${money(client.amount)}</p></div>
                            <div><label>Parcelas Pagas</label><p>${paidInstallments}/${totalInstallments}</p></div>
                            <div><label>Taxa de Juros</label><p>${client.interestRate || 'N/A'}%</p></div>
                        </div>
                    </section>

                    <section>
                        <h2 class="section-title">Histórico de Pagamentos</h2>
                        <div class="item-list">${historyHtml}</div>
                    </section>

                    <section>
                        <h2 class="section-title">Documentos</h2>
                        <div class="item-list">${docsHtml}</div>
                    </section>
                </div>
            `;

            detailModal.classList.add('active');
            lucide.createIcons({nodes: detailModal.querySelectorAll('[data-lucide]')});
            applyLanguage(currentLang);
            detailModal.querySelector('#closeClientDetail').addEventListener('click', () => detailModal.classList.remove('active'));
            detailModal.querySelector('#editClientBtn').addEventListener('click', (e) => {
                showClientFormModal(e.currentTarget.dataset.clientId);
            });
        }

        function showCollectorFormModal(collectorId = null) {
            const isEditMode = collectorId !== null;
            const collector = isEditMode ? allCollectors.find(c => c.id === collectorId) : {};

            const modalTitleKey = isEditMode ? 'editCollector' : 'addNewCollector';
            const saveButtonKey = isEditMode ? 'saveChanges' : 'saveCollector';
            
            const formModal = document.getElementById('collectorFormModal');
            formModal.innerHTML = `
                <header class="modal-header">
                    <button id="closeCollectorForm"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title" data-lang-key="${modalTitleKey}"></span>
                </header>
                <div class="modal-content-wrapper container">
                    <form id="collector-form">
                        <div class="form-group">
                            <label for="collector-name" data-lang-key="fullName"></label>
                            <input type="text" id="collector-name" required value="${collector.name || ''}">
                        </div>
                        <div class="form-group">
                            <label for="collector-address" data-lang-key="address"></label>
                            <input type="text" id="collector-address" value="${collector.address || ''}">
                        </div>
                        <div class="form-group grid-2">
                            <div>
                                <label for="collector-phone" data-lang-key="phone"></label>
                                <input type="tel" id="collector-phone" value="${collector.phone || ''}">
                            </div>
                            <div>
                                <label for="collector-whatsapp" data-lang-key="whatsapp"></label>
                                <input type="tel" id="collector-whatsapp" value="${collector.whatsapp || ''}">
                            </div>
                        </div>
                        <hr style="border: 1px solid var(--border-color); margin: 30px 0;">
                        <div class="form-group">
                            <label for="collector-username" data-lang-key="username"></label>
                            <input type="text" id="collector-username" required value="${collector.id || ''}" ${isEditMode ? 'readonly' : ''}>
                        </div>
                        <div class="form-group">
                            <label for="collector-password" data-lang-key="password"></label>
                            <input type="password" id="collector-password" ${!isEditMode ? 'required' : ''} placeholder="${isEditMode ? 'Deixe em branco para não alterar' : ''}">
                        </div>
                        <div class="form-group">
                            <label for="collector-capital" data-lang-key="initialCapital"></label>
                            <input type="number" id="collector-capital" step="0.01" required value="${collector.startingCapital || ''}">
                        </div>
                    </form>
                </div>
                <div class="action-buttons">
                    <button id="saveCollectorBtn" class="btn-primary"><i data-lucide="save"></i> <span data-lang-key="${saveButtonKey}"></span></button>
                </div>
            `;
            formModal.classList.add('active');
            lucide.createIcons({nodes: formModal.querySelectorAll('[data-lucide]')});
            applyLanguage(currentLang);
            
            formModal.querySelector('#closeCollectorForm').addEventListener('click', () => formModal.classList.remove('active'));
            formModal.querySelector('#saveCollectorBtn').addEventListener('click', async () => {
                const username = document.getElementById('collector-username').value.trim();
                const name = document.getElementById('collector-name').value.trim();
                const password = document.getElementById('collector-password').value.trim();
                const capital = parseFloat(document.getElementById('collector-capital').value);

                if (!username || !name || isNaN(capital) || (!isEditMode && !password)) {
                    showToast(translations[currentLang].fillFields, true);
                    return;
                }

                const collectorData = {
                    name,
                    address: document.getElementById('collector-address').value,
                    phone: document.getElementById('collector-phone').value,
                    whatsapp: document.getElementById('collector-whatsapp').value,
                    startingCapital: capital,
                };

                if (password) {
                    collectorData.password = password;
                }
                
                try {
                    if(isEditMode) {
                        await updateDoc(doc(db, "collectors", collectorId), collectorData);
                        showToast(translations[currentLang].collectorUpdated);
                    } else {
                        await setDoc(doc(db, "collectors", username), {
                            ...collectorData,
                            profilePictureUrl: '',
                            isRealtimeTrackingActive: false,
                        });
                        showToast(translations[currentLang].collectorAdded);
                    }
                    formModal.classList.remove('active');
                } catch (error) {
                    console.error("Erro ao salvar cobrador: ", error);
                    showToast(translations[currentLang].errorSaving, true);
                }
            });
        }
        
        function showClientFormModal(clientId) {
            const client = allClients.find(c => c.id === clientId);
            if (!client) {
                showToast('Cliente não encontrado.', true);
                return;
            }

            const formModal = document.getElementById('clientFormModal');
            const collectorOptions = allCollectors.map(c =>
                `<option value="${c.id}" ${c.id === client.collectorId ? 'selected' : ''}>${c.name}</option>`
            ).join('');

            const modalTitleKey = 'editClient';
            const saveButtonKey = 'saveChanges';

            formModal.innerHTML = `
                <header class="modal-header">
                    <button id="closeClientForm"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title" data-lang-key="${modalTitleKey}"></span>
                </header>
                <div class="modal-content-wrapper container">
                    <form id="client-form-edit">
                        <div class="form-group">
                            <label>Nome do Cliente</label>
                            <input type="text" id="client-name" required value="${client.name || ''}">
                        </div>
                        <div class="form-group">
                            <label>Endereço</label>
                            <input type="text" id="client-address" value="${client.address || ''}">
                        </div>
                         <div class="form-group grid-2">
                            <div>
                                <label>WhatsApp</label>
                                <input type="tel" id="client-whatsapp" value="${client.whatsapp || ''}">
                            </div>
                            <div>
                                <label>Telefone Opcional</label>
                                <input type="tel" id="client-phone" value="${client.phone || ''}">
                            </div>
                        </div>
                        <hr style="border: 1px solid var(--border-color); margin: 30px 0;">
                        <div class="form-group">
                            <label>Cobrador</label>
                            <select id="client-collector">${collectorOptions}</select>
                        </div>
                        <div class="form-group grid-2">
                            <div><label>Valor do Empréstimo</label><input type="number" id="client-loan-amount" required value="${(client.totalLoan && client.interestRate) ? (client.totalLoan / (1 + client.interestRate/100)).toFixed(2) : ''}"></div>
                            <div><label>Juros (%)</label><input type="number" id="client-interest" required value="${client.interestRate || '20'}"></div>
                        </div>
                        <div class="form-group"><label>Valor Total a Pagar</label><input type="text" id="client-total-to-pay" readonly></div>
                        <div class="form-group grid-2">
                             <div><label>Número de Parcelas</label><input type="number" id="client-installments" required value="${client.installments ? client.installments.split('/')[1] : ''}"></div>
                            <div><label>Valor da Parcela</label><input type="text" id="client-installment-value" readonly></div>
                        </div>
                         <div class="form-group">
                            <label>Dias de Pagamento</label>
                            <div class="day-selector">
                                ${['D','S','T','Q','Q','S','S'].map((day, i) => `<div><input type="checkbox" id="form-day-${i}" value="${i}"><label for="form-day-${i}">${day}</label></div>`).join('')}
                            </div>
                        </div>
                    </form>
                </div>
                <div class="action-buttons">
                    <button id="deleteClientBtn" class="btn-danger"><i data-lucide="trash"></i> <span data-lang-key="deleteClient"></span></button>
                    <button id="saveClientBtn" class="btn-primary"><i data-lucide="save"></i> <span data-lang-key="${saveButtonKey}"></span></button>
                </div>
            `;
            formModal.classList.add('active');
            lucide.createIcons({nodes: formModal.querySelectorAll('[data-lucide]')});
            applyLanguage(currentLang);

            (client.paymentDays || []).forEach(day => {
                const checkbox = formModal.querySelector(`#form-day-${day}`);
                if (checkbox) checkbox.checked = true;
            });

            const loanAmountInput = formModal.querySelector('#client-loan-amount');
            const interestInput = formModal.querySelector('#client-interest');
            const installmentsInput = formModal.querySelector('#client-installments');
            const totalToPayInput = formModal.querySelector('#client-total-to-pay');
            const installmentValueInput = formModal.querySelector('#client-installment-value');

            function calculateLoanDetails() {
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const interest = parseFloat(interestInput.value) || 0;
                const installments = parseInt(installmentsInput.value) || 0;
                const totalToPay = loanAmount * (1 + (interest / 100));
                const installmentValue = installments > 0 ? totalToPay / installments : 0;
                totalToPayInput.value = money(totalToPay);
                installmentValueInput.value = money(installmentValue);
            }
            [loanAmountInput, interestInput, installmentsInput].forEach(input => input.addEventListener('input', calculateLoanDetails));
            calculateLoanDetails();
            
            formModal.querySelector('#closeClientForm').addEventListener('click', () => formModal.classList.remove('active'));
            
            formModal.querySelector('#saveClientBtn').addEventListener('click', async () => {
                 const loanAmount = parseFloat(loanAmountInput.value);
                 const interest = parseFloat(interestInput.value);
                 const installments = parseInt(installmentsInput.value);
                 const totalToPay = loanAmount * (1 + (interest / 100));
                 const installmentValue = installments > 0 ? totalToPay / installments : 0;
                 
                 const updatedData = {
                    name: document.getElementById('client-name').value,
                    address: document.getElementById('client-address').value,
                    whatsapp: document.getElementById('client-whatsapp').value,
                    phone: document.getElementById('client-phone').value,
                    collectorId: document.getElementById('client-collector').value,
                    totalLoan: totalToPay,
                    amount: installmentValue,
                    installments: `${client.installments.split('/')[0]}/${installments}`,
                    interestRate: interest,
                    paymentDays: Array.from(document.querySelectorAll('#clientFormModal .day-selector input:checked')).map(el => parseInt(el.value)),
                 };

                try {
                    await updateDoc(doc(db, "clients", clientId), updatedData);
                    showToast(translations[currentLang].clientUpdated);
                    formModal.classList.remove('active');
                    document.getElementById('clientDetailModal').classList.remove('active');
                } catch(error) {
                    console.error("Error updating client:", error);
                    showToast("Error updating client.", true);
                }
            });

            formModal.querySelector('#deleteClientBtn').addEventListener('click', async () => {
                const deleteBtn = formModal.querySelector('#deleteClientBtn');
                if (deleteBtn.dataset.confirming !== 'true') {
                    deleteBtn.dataset.confirming = 'true';
                    deleteBtn.innerHTML = `<i data-lucide="alert-triangle"></i> ${translations[currentLang].delete}`;
                    lucide.createIcons({nodes: [deleteBtn.querySelector('i')]});
                    setTimeout(() => {
                        deleteBtn.dataset.confirming = 'false';
                        deleteBtn.innerHTML = `<i data-lucide="trash"></i> <span data-lang-key="deleteClient"></span>`;
                        applyLanguage(currentLang);
                        lucide.createIcons({nodes: [deleteBtn.querySelector('i')]});
                    }, 3000);
                    return;
                }

                try {
                    await deleteDoc(doc(db, "clients", clientId));
                    showToast(translations[currentLang].clientDeleted);
                    formModal.classList.remove('active');
                    document.getElementById('clientDetailModal').classList.remove('active');
                    document.getElementById('collectorDetailView').classList.remove('active');
                } catch (error) {
                    console.error("Error deleting client: ", error);
                    showToast("Erro ao excluir cliente.", true);
                }
            });
        }

        function showCropperModal(file) {
            const cropperModal = document.getElementById('cropperModal');
            cropperModal.innerHTML = `
                <header class="modal-header">
                    <button id="closeCropperModal"><i data-lucide="x"></i></button>
                    <span class="modal-title">Recortar Imagem</span>
                </header>
                <div class="modal-content-wrapper">
                    <div id="cropper-container" class="container">
                        <img id="cropper-image">
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-secondary" id="cancelCropBtn"><i data-lucide="x-circle"></i> Cancelar</button>
                    <button class="btn-primary" id="confirmCropBtn"><i data-lucide="check-circle"></i> Confirmar</button>
                </div>
            `;
            cropperModal.classList.add('active');
            lucide.createIcons({nodes: cropperModal.querySelectorAll('[data-lucide]')});

            const image = document.getElementById('cropper-image');
            const reader = new FileReader();
            let cropper;

            reader.onload = (e) => {
                image.src = e.target.result;
                cropper = new Cropper(image, { aspectRatio: 1, viewMode: 1, background: false });
            };
            reader.readAsDataURL(file);

            document.getElementById('closeCropperModal').addEventListener('click', () => cropperModal.classList.remove('active'));
            document.getElementById('cancelCropBtn').addEventListener('click', () => cropperModal.classList.remove('active'));
            document.getElementById('confirmCropBtn').addEventListener('click', () => {
                cropper.getCroppedCanvas({ width: 256, height: 256, imageSmoothingQuality: 'high' }).toBlob((blob) => {
                    handleProfilePictureChange(blob);
                    cropperModal.classList.remove('active');
                }, 'image/jpeg');
            });
        }

        async function handleProfilePictureChange(blob) {
            if (!blob) return;
            const profileImageView = document.getElementById('profile-view-img');
            const headerImageView = document.querySelector('.profile img');

            const localUrl = URL.createObjectURL(blob);
            profileImageView.src = localUrl;
            headerImageView.src = localUrl;
            
            try {
                const formData = new FormData();
                formData.append('file', blob);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Cloudinary upload failed');
                const data = await response.json();
                const downloadURL = data.secure_url;
                
                await setDoc(doc(db, 'admins', 'admin'), { profilePictureUrl: downloadURL }, { merge: true });
                showToast('Foto de perfil atualizada!');
            } catch (error) {
                console.error("Erro ao atualizar foto de perfil: ", error);
                showToast('Falha ao atualizar a foto de perfil.', true);
            }
        }
        
        function applyLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
        }

        function setupEventListeners() {
            document.body.addEventListener('click', e => {
                const target = e.target;

                if (target.closest('#theme-toggle')) {
                    const isDarkMode = document.body.classList.toggle('dark-mode');
                    localStorage.setItem('adminTheme', isDarkMode ? 'dark' : 'light');
                    applyTheme(isDarkMode ? 'dark' : 'light');
                }
                const langToggle = target.closest('#lang-toggle');
                const langDropdown = document.getElementById('lang-dropdown');
                if (langToggle) {
                    e.stopPropagation();
                    langDropdown.style.display = langDropdown.style.display === 'block' ? 'none' : 'block';
                } else {
                    if (langDropdown) langDropdown.style.display = 'none';
                }
                const langBtn = target.closest('[data-lang]');
                if(langBtn) {
                    const newLang = langBtn.dataset.lang;
                    localStorage.setItem('adminLanguage', newLang);
                    applyLanguage(newLang);
                    updateDashboard();
                    updateProfileView();
                }

                const collectorCard = target.closest('.collector-card');
                if (collectorCard) {
                    showCollectorDetails(collectorCard.dataset.collectorId);
                }

                const reportCollectorCard = target.closest('.report-item-card.clickable');
                 if (reportCollectorCard) {
                    showCollectorDetails(reportCollectorCard.dataset.collectorId);
                }

                const filterBtn = target.closest('#dashboard-view .filter-btn[data-filter]');
                if (filterBtn) {
                    document.querySelectorAll('#dashboard-view .filter-btn[data-filter]').forEach(btn => btn.classList.remove('active'));
                    filterBtn.classList.add('active');
                    updateDashboard();
                }

                const sortBtn = target.closest('#dashboard-view .filter-btn[data-sort]');
                if (sortBtn) {
                    sortBtn.classList.toggle('active');
                    updateDashboard();
                }
                
                const navItem = target.closest('.nav-item');
                if (navItem) {
                    if (mapInstance) {
                        mapInstance.closePopup();
                    }
                    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                    navItem.classList.add('active');
                    document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
                    const viewId = `${navItem.dataset.view}-view`;
                    document.getElementById(viewId).classList.add('active');

                    if(viewId === 'map-view'){
                         setTimeout(() => {
                            initMap();
                            updateCollectorMarkers();
                        }, 50);
                    }
                    if(viewId === 'reports-view'){
                        updateReportsView();
                    }
                }
                 if (target.closest('#addCollectorBtn')) {
                    showCollectorFormModal();
                }
                if (target.closest('#save-settings-btn')) {
                    saveGlobalSettings();
                }
                 if (target.closest('#reportOptionsModal')) {
                    if (target.classList.contains('modal-overlay') || target.closest('.close-modal-btn')) {
                        document.getElementById('reportOptionsModal').classList.remove('active');
                    }
                }

                const reportsFilterBtn = target.closest('#reports-view .filter-btn');
                if(reportsFilterBtn) {
                    document.querySelectorAll('#reports-view .filter-btn').forEach(btn => btn.classList.remove('active'));
                    reportsFilterBtn.classList.add('active');
                    updateReportsView();
                }
            });

            document.body.addEventListener('change', e => {
                if (e.target.id === 'admin-profile-pic-input') {
                    const file = e.target.files[0];
                    if (file) showCropperModal(file);
                }
                if (e.target.id === 'report-collector-filter') {
                    updateReportsView();
                }
                 if (e.target.id === 'settings-logo-input') {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            document.getElementById('settings-logo-preview').src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                        document.getElementById('save-settings-btn').disabled = false;
                    }
                }
            });
            
            document.body.addEventListener('input', e => {
                const target = e.target;
                if (target.id === 'collector-search-input') {
                    updateDashboard();
                }
                if (target.closest('#settings-view')) {
                    document.getElementById('save-settings-btn').disabled = false;
                    if(target.id === 'settings-company-name'){
                         document.getElementById('header-logo-text').textContent = target.value;
                    }
                }
            });
        }
        
        function applyTheme(theme) {
            document.body.classList.toggle('dark-mode', theme === 'dark');
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.innerHTML = `<i data-lucide="${theme === 'dark' ? 'sun' : 'moon'}"></i>`;
                lucide.createIcons({ nodes: [themeToggle] });
            }
        }

        function loadGlobalSettings(settings) {
            globalSettings = settings || {};
            const companyName = globalSettings.companyName || 'LUMIX Finanças';
            const companyLogo = globalSettings.companyLogo || DEFAULT_LOGO_URL;
            
            const elements = {
                headerLogoText: document.getElementById('header-logo-text'),
                headerLogo: document.getElementById('header-logo'),
                splashLogo: document.getElementById('splash-logo'),
                loginLogo: document.getElementById('login-logo'),
                companyNameInput: document.getElementById('settings-company-name'),
                logoPreview: document.getElementById('settings-logo-preview'),
                interestInput: document.getElementById('settings-default-interest'),
                gpsToggle: document.getElementById('settings-gps-toggle')
            };

            if (elements.headerLogoText) elements.headerLogoText.textContent = companyName;
            if (elements.headerLogo) elements.headerLogo.src = companyLogo;
            if (elements.splashLogo) elements.splashLogo.src = companyLogo;
            if (elements.loginLogo) elements.loginLogo.src = companyLogo;
            if (elements.companyNameInput) elements.companyNameInput.value = companyName;
            if (elements.logoPreview) elements.logoPreview.src = companyLogo;
            if (elements.interestInput) elements.interestInput.value = globalSettings.defaultInterestRate || 20;
            if (elements.gpsToggle) elements.gpsToggle.checked = globalSettings.isGpsTrackingRequired === true;
        }


        async function saveGlobalSettings() {
            const companyName = document.getElementById('settings-company-name').value;
            const defaultInterestRate = parseFloat(document.getElementById('settings-default-interest').value);
            const isGpsTrackingRequired = document.getElementById('settings-gps-toggle').checked;
            const logoFile = document.getElementById('settings-logo-input').files[0];

            const settingsData = {
                companyName,
                defaultInterestRate,
                isGpsTrackingRequired,
                companyLogo: globalSettings.companyLogo || DEFAULT_LOGO_URL
            };
            
            const saveBtn = document.getElementById('save-settings-btn');
            const originalBtnHtml = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<i data-lucide="loader-2" style="animation: spin 1s linear infinite;"></i>`;
            lucide.createIcons({nodes: [saveBtn.querySelector('i')]});

            try {
                if (logoFile) {
                    const formData = new FormData();
                    formData.append('file', logoFile);
                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error('Cloudinary upload failed');
                    const data = await response.json();
                    settingsData.companyLogo = data.secure_url;
                }

                await setDoc(doc(db, "config", "global"), settingsData);
                showToast(translations[currentLang].settingsSaved);
            } catch (error) {
                console.error("Error saving settings:", error);
                showToast("Error saving settings.", true);
            } finally {
                saveBtn.innerHTML = originalBtnHtml;
                lucide.createIcons({nodes: [saveBtn.querySelector('i')]});
                saveBtn.disabled = true; 
            }
        }


        function updateReportFilters(){
            const collectorFilter = document.getElementById('report-collector-filter');
            if (!collectorFilter) return;
            collectorFilter.innerHTML = '<option value="all">Todos os Cobradores</option>';
            allCollectors.forEach(c => {
                collectorFilter.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        }

        function updateReportsView() {
            const resultsContainer = document.getElementById('report-results');
            const collectorFilter = document.getElementById('report-collector-filter');
            const periodFilter = document.querySelector('#reports-view .filter-btn.active');
            
            if(!resultsContainer || !collectorFilter || !periodFilter) return;

            const collectorId = collectorFilter.value;
            const period = periodFilter.dataset.period;
            
            let startDate;
            const now = new Date();
            if (period === 'today') {
                startDate = new Date(new Date().setHours(0, 0, 0, 0));
            } else if (period === 'week') {
                const firstDayOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
                startDate = new Date(firstDayOfWeek.setHours(0,0,0,0));
            } else if (period === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            }

            const clientsInPeriod = allClients.filter(c => !startDate || (c.startDate && c.startDate.toDate() >= startDate));
            const expensesInPeriod = allExpenses.filter(e => !startDate || (e.date && e.date.toDate() >= startDate));
            const paymentsInPeriod = allClients.flatMap(c => (c.history || []).map(h => ({...h, clientName: c.name, collectorId: c.collectorId})) )
                .filter(p => p.date && p.date.seconds && (!startDate || new Date(p.date.seconds * 1000) >= startDate));

            const filteredClients = (collectorId === 'all') ? clientsInPeriod : clientsInPeriod.filter(c => c.collectorId === collectorId);
            const filteredExpenses = (collectorId === 'all') ? expensesInPeriod : expensesInPeriod.filter(e => e.collectorId === collectorId);
            const filteredPayments = (collectorId === 'all') ? paymentsInPeriod : paymentsInPeriod.filter(p => p.collectorId === collectorId);

            const totalCollected = filteredPayments.reduce((sum, p) => sum + p.amount, 0);
            const totalExpenses = filteredExpenses.reduce((sum, e) => sum + e.value, 0);
            const netBalance = totalCollected - totalExpenses;
            
            let reportContent = '';

            if (collectorId === 'all') {
                const totalDeployed = clientsInPeriod.filter(c => c.startDate && c.startDate.toDate() >= (startDate || 0)).reduce((sum, c) => sum + (c.totalLoan / (1 + (c.interestRate || 20)/100)), 0);
                const totalInterest = paymentsInPeriod.reduce((sum, p) => {
                    const client = allClients.find(c => c.name === p.clientName);
                    return sum + (p.amount * ((client.interestRate || 20) / (100 + (client.interestRate || 20))));
                }, 0);
                const lateClientsCount = allClients.filter(c => c.status === 'late').length;
                const delinquencyRate = allClients.length > 0 ? (lateClientsCount / allClients.length) * 100 : 0;
                
                reportContent += `
                    <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                        <div class="kpi-card"><h3 class="kpi-title" data-lang-key="collectedToday"></h3><p class="kpi-value" style="color:var(--accent-green)">${money(totalCollected)}</p></div>
                        <div class="kpi-card"><h3 class="kpi-title" data-lang-key="capitalDeployed"></h3><p class="kpi-value">${money(totalDeployed)}</p></div>
                        <div class="kpi-card"><h3 class="kpi-title" data-lang-key="interestGenerated"></h3><p class="kpi-value">${money(totalInterest)}</p></div>
                        <div class="kpi-card"><h3 class="kpi-title" data-lang-key="delinquencyRate"></h3><p class="kpi-value" style="color:var(--danger-color)">${delinquencyRate.toFixed(1)}%</p></div>
                    </div>`;

                const expensesByCategory = filteredExpenses.reduce((acc, expense) => {
                    const categoryKey = translations[currentLang][expense.category] || expense.category;
                    acc[categoryKey] = (acc[categoryKey] || 0) + expense.value;
                    return acc;
                }, {});

                const performanceByCollector = allCollectors.map(collector => {
                    const collected = filteredPayments.filter(p => p.collectorId === collector.id).reduce((sum, p) => sum + p.amount, 0);
                    return { id: collector.id, name: collector.name, collected };
                }).sort((a,b) => b.collected - a.collected);

                reportContent += `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div>
                            <h2 class="section-title">Gastos por Categoria</h2>
                            <div class="item-list">
                                ${Object.keys(expensesByCategory).length > 0 ? Object.entries(expensesByCategory).map(([category, value]) => `
                                    <div class="report-item-card">
                                        <div class="item-info"><p class="item-name" style="text-transform:capitalize;">${category}</p></div>
                                        <strong style="color: var(--danger-color)">-${money(value)}</strong>
                                    </div>
                                `).join('') : '<p>Nenhum gasto no período.</p>'}
                            </div>
                        </div>
                        <div>
                            <h2 class="section-title">Rendimento por Cobrador</h2>
                            <div class="item-list">
                                ${performanceByCollector.length > 0 ? performanceByCollector.map(p => `
                                    <div class="report-item-card clickable" data-collector-id="${p.id}">
                                        <div class="item-info"><p class="item-name">${p.name}</p></div>
                                        <strong style="color: var(--accent-green)">+${money(p.collected)}</strong>
                                    </div>
                                `).join('') : '<p>Nenhum rendimento no período.</p>'}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                 reportContent += `
                    <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                        <div class="kpi-card"><h3 class="kpi-title">Total Arrecadado</h3><p class="kpi-value" style="color:var(--accent-green)">${money(totalCollected)}</p></div>
                        <div class="kpi-card"><h3 class="kpi-title">Total de Gastos</h3><p class="kpi-value" style="color:var(--danger-color)">-${money(totalExpenses)}</p></div>
                        <div class="kpi-card"><h3 class="kpi-title">Saldo Líquido</h3><p class="kpi-value">${money(netBalance)}</p></div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div>
                            <h2 class="section-title">Pagamentos Recebidos</h2>
                            <div class="item-list">
                                ${filteredPayments.length > 0 ? filteredPayments.map(p => `
                                    <div class="report-item-card">
                                        <div class="item-info">
                                            <p class="item-name">${p.clientName}</p>
                                            <p class="item-subtext">${new Date(p.date.seconds * 1000).toLocaleString()}</p>
                                        </div>
                                        <strong style="color: var(--accent-green)">+${money(p.amount)}</strong>
                                    </div>
                                `).join('') : '<p>Nenhum pagamento no período.</p>'}
                            </div>
                        </div>
                        <div>
                            <h2 class="section-title">Despesas Registradas</h2>
                            <div class="item-list">
                                ${filteredExpenses.length > 0 ? filteredExpenses.map(e => `
                                    <div class="report-item-card">
                                        <div class="item-info">
                                            <p class="item-name" style="text-transform:capitalize;">${translations[currentLang][e.category] || e.category}</p>
                                            <p class="item-subtext">${new Date(e.date.seconds * 1000).toLocaleDateString()}</p>
                                        </div>
                                        <strong style="color: var(--danger-color)">-${money(e.value)}</strong>
                                    </div>
                                `).join('') : '<p>Nenhuma despesa no período.</p>'}
                            </div>
                        </div>
                    </div>
                `;
            }

            resultsContainer.innerHTML = reportContent;
            applyLanguage(currentLang);
        }
        
        function initMap() {
            if (mapInstance) {
                mapInstance.invalidateSize(); 
                return;
            };
            mapInstance = L.map('map-container').setView([-16.68, -49.25], 12); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);

            mapInstance.getContainer().addEventListener('click', (e) => {
                const link = e.target.closest('.popup-action-link');
                if (link && link.dataset.collectorId) {
                    const collectorId = link.dataset.collectorId;
                    if (mapInstance && collectorMarkers[collectorId]) {
                        mapInstance.closePopup();
                    }
                    showCollectorDetails(collectorId);
                }
            });
        }

        function updateCollectorMarkers() {
            if (!mapInstance) return;

            allCollectors.forEach(collector => {
                const location = collector.liveLocation;
                if (location && location.latitude && location.longitude) {
                    const latLng = [location.latitude, location.longitude];
                    
                    const collectorClients = allClients.filter(c => c.collectorId === collector.id);
                    const capitalOnHand = (collector.startingCapital || 0) + collectorClients.reduce((sum, c) => sum + (c.paid || 0), 0) - collectorClients.reduce((sum, c) => sum + (c.totalLoan / (1 + (c.interestRate || 0)/100)), 0);
                    const placeholderUrl = `https://placehold.co/96x96/0f172a/FFFFFF?text=${(collector.name || 'C').charAt(0)}`;
                    const status = calculateCollectorStatus(collector.id);
                    
                    const popupContent = `
                        <div class="map-popup-card">
                            <div class="popup-header">
                                <img src="${collector.profilePictureUrl || placeholderUrl}" alt="Foto do Cobrador" class="popup-avatar">
                                <div class="popup-info">
                                    <strong class="popup-name">${collector.name}</strong>
                                    <div class="item-status-tag" style="background-color: ${status.color}20; color: ${status.color};">
                                        <i data-lucide="${status.icon}" style="width: 12px; height: 12px;"></i>
                                        <span data-lang-key="${status.textKey}"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="popup-stats">
                                <div>
                                    <span class="stat-label" data-lang-key="capitalOnHand"></span>
                                    <strong class="stat-value">${money(capitalOnHand)}</strong>
                                </div>
                                <div>
                                    <span class="stat-label" data-lang-key="clients"></span>
                                    <strong class="stat-value">${collectorClients.length}</strong>
                                </div>
                            </div>
                            <div class="popup-actions" style="display: flex; justify-content: space-around; align-items: center; padding: 12px;">
                                <a class="popup-action-link" data-collector-id="${collector.id}">
                                    <i data-lucide="user"></i> <span data-lang-key="viewProfile"></span>
                                </a>
                                ${collector.whatsapp ? `
                                <a class="popup-action-link" href="https://wa.me/${collector.whatsapp.replace(/\D/g, '')}" target="_blank">
                                    <svg viewBox="0 0 16 16" width="14" height="14" fill="#25D366" xmlns="http://www.w3.org/2000/svg" style="flex-shrink: 0;"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg> 
                                    <span data-lang-key="whatsapp"></span>
                                </a>
                                ` : ''}
                            </div>
                        </div>
                    `;

                    let marker = collectorMarkers[collector.id];
                    if (marker) {
                        marker.setLatLng(latLng).setPopupContent(popupContent);
                    } else {
                        marker = L.marker(latLng).addTo(mapInstance);
                        marker.bindPopup(popupContent);
                        collectorMarkers[collector.id] = marker;
                    }

                    marker.off('popupopen').on('popupopen', (e) => {
                        setTimeout(() => {
                            const popupNode = e.popup.getElement()?.querySelector('.leaflet-popup-content');
                            if(popupNode) {
                                lucide.createIcons({ nodes: popupNode.querySelectorAll('[data-lucide]')});
                                popupNode.querySelectorAll('[data-lang-key]').forEach(el => {
                                    const key = el.dataset.langKey;
                                    if (translations[currentLang] && translations[currentLang][key]) {
                                        el.textContent = translations[currentLang][key];
                                    }
                                });
                            }
                        }, 10);
                    });

                } else {
                    if (collectorMarkers[collector.id]) {
                        collectorMarkers[collector.id].remove();
                        delete collectorMarkers[collector.id];
                    }
                }
            });
        }
        
        function focusOnCollector(collectorId) {
            const detailView = document.getElementById('collectorDetailView');
            if (detailView) {
                detailView.classList.remove('active');
            }

            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById('map-view').classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const mapNavItem = document.querySelector('.nav-item[data-view="map"]');
            if (mapNavItem) {
                mapNavItem.classList.add('active');
            }
            
            setTimeout(() => {
                initMap();
                updateCollectorMarkers(); 
                
                const marker = collectorMarkers[collectorId];
                if (marker) {
                    mapInstance.setView(marker.getLatLng(), 16);
                    marker.openPopup();
                } else {
                    const collector = allCollectors.find(c => c.id === collectorId);
                    if (collector && collector.liveLocation) {
                         mapInstance.setView([collector.liveLocation.latitude, collector.liveLocation.longitude], 16);
                         setTimeout(() => {
                             if (collectorMarkers[collectorId]) {
                                 collectorMarkers[collectorId].openPopup();
                             }
                         }, 100);
                    } else {
                        showToast('Localização do cobrador não disponível.', true);
                    }
                }
            }, 100); 
        }

        function showMainApp() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';

            renderMainLayout();
            const preferredTheme = localStorage.getItem('adminTheme') || 'light';
            applyTheme(preferredTheme);
            lucide.createIcons();
            setupEventListeners();
            applyLanguage(currentLang);
            
             const dummyLocations = [
                { id: 'joao_silva', location: { latitude: -16.6786, longitude: -49.2539 }, active: true, lastUpdate: null },
                { id: 'maria_souza', location: { latitude: -16.7027, longitude: -49.2435 }, active: false, lastUpdate: Timestamp.fromDate(new Date(Date.now() - 2 * 60 * 60 * 1000)) },
                { id: 'carlos_pereira', location: { latitude: -16.695, longitude: -49.278 }, active: true, lastUpdate: null }
            ];

            onSnapshot(collection(db, 'collectors'), (snapshot) => {
                allCollectors = snapshot.docs.map(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    const dummyData = dummyLocations.find(d => d.id === data.id);
                    if (dummyData) {
                          data.liveLocation = dummyData.location;
                          data.isRealtimeTrackingActive = dummyData.active;
                          data.lastLocationUpdate = dummyData.lastUpdate;
                    }
                    return data;
                });
                updateDashboard();
                updateProfileView();
                updateCollectorMarkers();
                updateReportFilters();
            });

            onSnapshot(collection(db, 'clients'), (snapshot) => {
                allClients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDashboard();
                updateProfileView();
            });

            onSnapshot(collection(db, 'expenses'), (snapshot) => {
                allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
            
            onSnapshot(doc(db, 'config', 'global'), (docSnap) => {
                if (docSnap.exists()) {
                    loadGlobalSettings(docSnap.data());
                } else {
                    setDoc(doc(db, "config", "global"), {
                        companyName: 'LUMIX Finanças',
                        companyLogo: DEFAULT_LOGO_URL,
                        defaultInterestRate: 20,
                        isGpsTrackingRequired: true,
                    });
                }
            });

            onSnapshot(doc(db, 'admins', 'admin'), (docSnap) => {
                if (docSnap.exists()) {
                    const adminData = docSnap.data();
                    if (adminData.profilePictureUrl) {
                        const imageUrl = adminData.profilePictureUrl;
                        document.querySelector('.profile img').src = imageUrl;
                        const profileImg = document.getElementById('profile-view-img');
                        if (profileImg) profileImg.src = imageUrl;
                    }
                }
            });
        }

        function handleLogin(event) {
            event.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;

            if (user === 'admin' && pass === '0000') {
                sessionStorage.setItem('isAdminLoggedIn', 'true');
                showMainApp();
            } else {
                showToast('Usuário ou senha inválidos.', true);
            }
        }

        function init() {
            document.body.classList.add('dark-mode');
            
            onSnapshot(doc(db, 'config', 'global'), (docSnap) => {
                if (docSnap.exists()) {
                    loadGlobalSettings(docSnap.data());
                } else {
                    loadGlobalSettings({}); // Load with defaults if no doc exists
                }
            });

            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.style.display = 'none';
                    if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                        showMainApp();
                    } else {
                        document.getElementById('login-view').style.display = 'flex';
                        document.getElementById('login-form').addEventListener('submit', handleLogin);
                    }
                }, 500);
            }, 1500);
        }
        init();
    </script>
</body>
</html>